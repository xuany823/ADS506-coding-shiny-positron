---
title: "ADS 506 - Week 5 Submission: Storytelling with Shiny Apps"
format: html
author: "Michelle Wang"
date: "June 10, 2024"
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(fpp3)
library(gt)
library(readr)
library(tidyverse)
```

## Tab1 - Visualization

### Data import / preparation

Inputs

-   Multiselct for varietals to display (default all display and selected with checkbox)
-   Date range selector
    -   First date selection fixed at January 1980
    -   Last date selection fixed at December 1994

```{r}
aus_wine <- read_csv("data/AustralianWines.csv"),
col_types = cols(Rose = col_number()), show_col_types = FALSE) |> 
    fill(Rose, .direction = "down") |> 
    mutate(Month = mdy(str_replace(Month, '-', '-01-')) |> yearmonth()) 

aus_wine_ts <- aus_wine |>
    pivot_longer(cols = -Month, names_to = 'Varietal', values_to = 'Sales') |> 
    as_tsibble(index = Month, key = Varietal)
aus_wine_ts
```

### Data visualization

Visualize the time series data for each varietal with a vertical line indicating the split between training and test sets (January 1994).

```{r}
autoplot(aus_wine_ts, Sales) +
    facet_wrap(~ Varietal, scales = "free_y", ncol = 1) +
    labs(x = "Month", y = "Sales") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    geom_vline(xintercept = as.Date(yearmonth("1994 Jan")), 
    color = "red", linetype = "dashed"
  )
```

### Data Splitting

```{r}
# training and test sets
train <- aus_wine_ts |> filter_index("1980 Jan" ~ "1993 Dec")
test <- aus_wine_ts |> filter_index("1994 Jan" ~ "1994 Dec")
```

## Tab2 - Modeling Building

Imputs:

-   Toggle for model type: TSLM, ETS, ARIMA
-   Toggle training accuracy
-   Toggle forecasting accuracy

### Model fitting

Built multiple models for each varietal using TSLM, auto ETS and auto ARIMA.

```{r}
fit <- train |> 
    model(TSLM(Sales ~ trend() + season()),
    ETS = ETS(Sales),
    ARIMA = ARIMA(Sales))

fit |> knitr::kable(caption = "Model specifications by Varietal")
```

The fitted models successfully report the required specifications: each varietal includes an ETS component form (e.g., ETS(M,A,M)) and a clearly identified ARIMA structure with full seasonal orders (e.g., ARIMA(0,0,0)(0,1,1)\[12\] w/ drift), which meets the MVP requirement for model specification.

### Training accuracy

```{r}
fit |> 
    accuracy() |> 
    select(Varietal, .model, RMSE, MAE, MAPE) |>
    arrange(RMSE) |> 
    knitr::kable(digits = 1, caption = "Training accuracy sorted by RMSE")
```

### Forecasting accuracy

```{r}
fc <- fit |> 
    forecast(test)
fc |> 
    accuracy(test) |> 
    select(Varietal, .model, RMSE, MAE, MAPE) |>
    arrange(RMSE) |>
    knitr::kable(digits = 1, caption = "Validation accuracy sorted by RMSE")
```

## Tab3 - Forecast

Inputs:\
\* User can select model type for forecast visualization and forecast table (TSLM, ETS, ARIMA)

### Forecast visualization

```{r}
fc |> 
    autoplot(train |> filter(Month >= yearmonth("1993 Jan"))) +
    facet_wrap(~ Varietal, scales = "free_y", ncol=1) +
    labs(title = "Australian Wine Sales Forecasts by Varietal",
    y = "Sales", x = "Month") +
        theme_minimal()
```

### Forecast table

```{r}

fc |>
  filter(.model == 'ARIMA', year(Month) == 1994) |>
  as_tibble() |>                         
  select(Varietal, .model, Month, .mean) |>
  pivot_wider(names_from = Month, values_from = .mean) |>
  knitr::kable(digits = 0, caption = "Forecasted Sales for 1994 by Varietal using ARIMA Model")
```

### Report generation

As an additional user-experience feature, I present the training and validation accuracy using formatted gt tables and focus the forecast visualization on the most recent history (from 1993 onward), which makes it easier to compare model performance and interpret the forecast region.