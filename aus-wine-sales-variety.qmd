---
title: "ADS 506 - Week 5 Submission: Storytelling with Shiny Apps"
format: html
author: "Michelle Wang"
date: "June 10, 2024"
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(fpp3)
library(gt)
library(readr)
library(tidyverse)
library(here)
```

## Tab1 - Visualization

### Data import / preparation

Inputs

* Multiselct for varietals to display (default all display and selected with checkbox)  
* Date range selector  
  * First date selection fixed at 1980-01-01  
  * Last date selection fixed at 1994-12-31  
  * Insert select date range scrolling bar for training cutoff  
  * Add bullet training cutoff: year month  

```{r}
aus_wine <- read_csv(
    here("data", "AustralianWines.csv"),
    col_types = cols(Rose = col_number()),
    show_col_types = FALSE
) |>
  fill(Rose, .direction = "down") |>
  mutate(Month = mdy(str_replace(Month, "-", "-01-")) |> yearmonth())

# Convert to tsibble (keyed by Varietal)
aus_wine_ts <- aus_wine |>
  pivot_longer(cols = -Month, names_to = "Varietal", values_to = "Sales") |>
  as_tsibble(index = Month, key = Varietal)

aus_wine_ts

```

### Data visualization

Visualize the time series data for each varietal with a vertical line indicating the split between training and test sets (January 1994).

```{r}
autoplot(aus_wine_ts, Sales) +
    facet_wrap(~ Varietal, scales = "free_y", ncol = 1) +
    labs(x = "Month", y = "Sales") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    geom_vline(xintercept = as.Date(yearmonth("1993 Dec")), 
    color = "red", linetype = "dashed"
  )
```

### Data Splitting

```{r}
# Create training cutoff date and split data
train_cutoff  <- yearmonth("1993 Dec")

data_trn <- aus_wine_ts |> 
  filter(Month < train_cutoff)
```

## Tab2 - Modeling Building

Inputs:  

  * Toggle for model specifications (default off)
  * Toggle training accuracy (default off)


### Model fitting

Built multiple models for each varietal using TSLM, auto ETS and auto ARIMA.

```{r}
fit <- data_trn |> 
    model(TSLM = TSLM(Sales ~ trend() + season()),
    ETS = ETS(Sales),
    ARIMA = ARIMA(Sales))
```

The fitted models successfully report the required specifications: each varietal includes an ETS component form (e.g., ETS(M,A,M)) and a clearly identified ARIMA structure with full seasonal orders (e.g., ARIMA(0,0,0)(0,1,1)\[12\] w/ drift), which meets the MVP requirement for model specification.

### Training accuracy

```{r}
fit |> 
    accuracy() |> 
    select(Varietal, .model, RMSE, MAE, MAPE) |>
    arrange(.model, MAPE) |> 
    knitr::kable(digits = 1, caption = "Training accuracy sorted by RMSE")
```


## Tab3 - Forecast

Inputs:
* Toggle forecasting accuracy (default off)  
* Toggle User can select model type for forecast visualization 

### Forecasting accuracy

```{r}
fc <- fit |> 
    forecast(h = "1 year")
fc |> 
    accuracy(aus_wine_ts) |> 
    select(Varietal, .model, RMSE, MAE, MAPE) |>
    arrange(.model, MAPE) |>
    knitr::kable(digits = 1, caption = "Validation accuracy sorted by RMSE")
```


### Forecast visualization
```{r}
trn_start <- train_cutoff - 24

fc |> 
    autoplot(aus_wine_ts |> filter(Month >= trn_start)) +
    facet_wrap(~ Varietal, scales = "free_y", ncol=1) +
    labs(title = "Australian Wine Sales Forecasts by Varietal",
    y = "Sales", x = "Month") +
        theme_minimal()
```


### Report generation

As an additional user-experience feature, I present the training and validation accuracy using formatted gt tables and focus the forecast visualization on the most recent history (from 1993 onward), which makes it easier to compare model performance and interpret the forecast region.