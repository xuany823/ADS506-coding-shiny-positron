---
title: "Untitled"
format: html
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(fpp3)
library(gt)
library(readr)
library(tidyverse)
```

# Data import / preparation

```{r}
aus_wine <- read_csv(here::here("data/AustralianWines.csv"),
col_types = cols(Rose = col_number()), show_col_types = FALSE) |> 
    fill(Rose, .direction = "down") |> 
    mutate(Month = mdy(str_replace(Month, '-', '-01-')) |> yearmonth()) 

aus_wine_ts <- aus_wine |>
    pivot_longer(cols = -Month, names_to = 'Varietal', values_to = 'Sales') |> 
    as_tsibble(index = Month, key = Varietal)
aus_wine_ts
```

# Data visualization

```{r}
# visualize with autoplot
aus_wine_ts |>
    autoplot(Sales) +
    facet_wrap(~ Varietal, scales = "free_y") +
    labs(x = "Month", y = "Sales") +
    theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

# Data Splitting

```{r}
# training and test sets
train <- aus_wine_ts |> filter_index("1980 Jan" ~ "1993 Dec")
test <- aus_wine_ts |> filter_index("1994 Jan" ~ "1994 Dec")
```


# Model fitting
Built multiple models for each varietal using auto ETS and auto ARIMA.

```{r}
fit <- train |> 
    model(TSLM(Sales ~ trend() + season()),
    ETS = ETS(Sales),
    ARIMA = ARIMA(Sales))

fit |> t()
```

The fitted models successfully report the required specifications: each varietal includes an ETS component form (e.g., ETS(M,A,M)) and a clearly identified ARIMA structure with full seasonal orders (e.g., ARIMA(0,0,0)(0,1,1)[12] w/ drift), which meets the MVP requirement for model specification.


# Training accuracy

```{r}
fit |> 
    accuracy() |> 
    select(Varietal, .model, Varietal, RMSE, MAE, MAPE) |>
    arrange(.model, Varietal) |>
    gt() |> fmt_number(decimals = 2)  
```

# Forecasting accuracy

```{r}
fc <- fit |> 
    forecast(test)
fc |> 
    accuracy(test) |> 
    select(Varietal, .model, Varietal, RMSE, MAE, MAPE) |>
    arrange(.model, Varietal) |>
    gt() |> fmt_number(decimals = 2)
```



# Forecast visualization

```{r}
fc |> 
    autoplot(train |> filter(Month >= yearmonth("1993 Jan"))) +
    facet_wrap(~ Varietal, scales = "free_y", ncol=1) +
    labs(title = "Australian Wine Sales Forecasts by Varietal",
    y = "Sales", x = "Month") +
        theme_minimal()
```


# Report generation